# üèóÔ∏è OrcaPro Backend

Sistema backend completo para gest√£o de or√ßamentos desenvolvido com NestJS, TypeScript e PostgreSQL.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Arquitetura do Sistema](#arquitetura-do-sistema)
- [Fluxo de Funcionamento](#fluxo-de-funcionamento)
- [Tecnologias](#tecnologias)
- [Instala√ß√£o](#instala√ß√£o)
- [Configura√ß√£o](#configura√ß√£o)
- [Documenta√ß√£o da API](#documenta√ß√£o-da-api)
- [Sistema de C√°lculos](#sistema-de-c√°lculos)
- [Estrutura do Banco de Dados](#estrutura-do-banco-de-dados)
- [Arquitetura de M√≥dulos](#arquitetura-de-m√≥dulos)

## üéØ Vis√£o Geral

O OrcaPro Backend √© uma API RESTful robusta que gerencia:

- üîê **Autentica√ß√£o e autoriza√ß√£o** com JWT
- üè¢ **Gest√£o de empresas** e usu√°rios
- üìã **Templates de or√ßamento** configur√°veis
- üßÆ **Sistema de c√°lculos** com m√∫ltiplas estrat√©gias
- üí∞ **Or√ßamentos** com valida√ß√£o e persist√™ncia
- üìä **Relat√≥rios** e an√°lises

## üèõÔ∏è Arquitetura do Sistema

```mermaid
graph TB
    subgraph "Frontend (Next.js)"
        A[Interface Web] --> B[API Client]
    end
    
    subgraph "Backend (NestJS)"
        B --> C[Controllers]
        C --> D[Services]
        D --> E[Calculation Engine]
        D --> F[Database Layer]
        
        subgraph "M√≥dulos Principais"
            G[Auth Module]
            H[Companies Module]
            I[Templates Module]
            J[Budgets Module]
        end
        
        subgraph "Calculation Strategies"
            K[Default Strategy]
            L[Industrial Strategy]
            M[Service Strategy]
        end
        
        E --> K
        E --> L
        E --> M
    end
    
    subgraph "Database"
        F --> N[(PostgreSQL)]
        N --> O[Companies]
        N --> P[Templates]
        N --> Q[Categories]
        N --> R[Fields]
        N --> S[Budgets]
        N --> T[Budget Items]
    end
```

## üîÑ Fluxo de Funcionamento

### 1. Fluxo de Autentica√ß√£o

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as Auth Controller
    participant S as Auth Service
    participant DB as Database
    
    U->>F: Login (email, password)
    F->>A: POST /auth/login
    A->>S: validateUser()
    S->>DB: findUser by email
    DB-->>S: User data
    S->>S: validatePassword()
    S-->>A: User validated
    A->>A: generateJWT()
    A-->>F: { token, user }
    F-->>U: Redirect to dashboard
```

### 2. Fluxo de Cria√ß√£o de Or√ßamento

```mermaid
sequenceDiagram
    participant F as Frontend
    participant BC as Budget Controller
    participant BS as Budget Service
    participant CE as Calculation Engine
    participant CS as Calculation Strategy
    participant DB as Database
    
    F->>BC: POST /budgets (template_id, items)
    BC->>BS: create()
    BS->>DB: findTemplate()
    DB-->>BS: Template with categories/fields
    BS->>CE: calculate()
    CE->>CE: determineStrategy()
    CE->>CS: validate()
    CS-->>CE: validation result
    CE->>CS: calculate()
    CS-->>CE: calculation result
    CE-->>BS: final result
    BS->>DB: START TRANSACTION
    BS->>DB: save budget
    BS->>DB: save budget items
    BS->>DB: COMMIT
    BS->>BS: findOne() (complete data)
    BS-->>BC: Budget created
    BC-->>F: Response with budget
```

### 3. Fluxo do Sistema de C√°lculos

```mermaid
graph TD
    A[Budget Items] --> B{Determine Strategy}
    B -->|Default| C[Default Strategy]
    B -->|Industrial| D[Industrial Strategy]
    B -->|Service| E[Service Strategy]
    
    C --> F[Validate Fields]
    D --> F
    E --> F
    
    F --> G{Validation OK?}
    G -->|No| H[Return Errors]
    G -->|Yes| I[Calculate Item Values]
    
    I --> J[Sum Category Totals]
    J --> K[Apply Tax Rates]
    K --> L[Generate Final Total]
    L --> M[Return Result]
```

## üõ†Ô∏è Tecnologias

- **Framework**: NestJS 10.x
- **Linguagem**: TypeScript 5.x
- **Banco de Dados**: PostgreSQL 15+
- **ORM**: TypeORM 0.3.x
- **Autentica√ß√£o**: JWT (Passport.js)
- **Valida√ß√£o**: class-validator, class-transformer
- **Documenta√ß√£o**: Swagger/OpenAPI

## ‚öôÔ∏è Instala√ß√£o

### Pr√©-requisitos

- Node.js 18+ 
- PostgreSQL 15+
- npm ou yarn

### Passos

1. **Clone o reposit√≥rio**
```bash
git clone https://github.com/Bryannps/2BackOrcaPro.git
cd 2BackOrcaPro
```

2. **Instale as depend√™ncias**
```bash
npm install
```

3. **Configure o banco de dados**
```bash
# Crie um banco PostgreSQL
createdb orcapro_db
```

4. **Configure as vari√°veis de ambiente**
```bash
cp .env.example .env
# Edite o arquivo .env com suas configura√ß√µes
```

5. **Execute as migrations**
```bash
npm run migration:run
```

6. **Execute os seeds (opcional)**
```bash
npm run seed:run
```

7. **Inicie o servidor**
```bash
# Desenvolvimento
npm run start:dev

# Produ√ß√£o
npm run build
npm run start:prod
```

## üîß Configura√ß√£o

### Vari√°veis de Ambiente (.env)

```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=your_password
DB_DATABASE=orcapro_db

# JWT
JWT_SECRET=your_super_secret_jwt_key
JWT_EXPIRES_IN=7d

# Application
PORT=3001
NODE_ENV=development

# CORS
CORS_ORIGIN=http://localhost:3000
```

## üìö Documenta√ß√£o da API

### Endpoints Principais

#### üîê Autentica√ß√£o
```
POST /auth/register     # Registrar usu√°rio
POST /auth/login        # Login
GET  /auth/profile      # Perfil do usu√°rio
POST /auth/refresh      # Refresh token
```

#### üè¢ Empresas
```
GET    /companies       # Listar empresas
GET    /companies/:id   # Buscar empresa
PUT    /companies/:id   # Atualizar empresa
DELETE /companies/:id   # Deletar empresa
```

#### üìã Templates
```
GET    /templates       # Listar templates
POST   /templates       # Criar template
GET    /templates/:id   # Buscar template
PUT    /templates/:id   # Atualizar template
DELETE /templates/:id   # Deletar template
```

#### üí∞ Or√ßamentos
```
GET    /budgets         # Listar or√ßamentos
POST   /budgets         # Criar or√ßamento
GET    /budgets/:id     # Buscar or√ßamento
PUT    /budgets/:id     # Atualizar or√ßamento
DELETE /budgets/:id     # Deletar or√ßamento
POST   /budgets/calculate # Calcular or√ßamento
```

### Exemplo de Request/Response

#### Criar Or√ßamento

**Request:**
```json
{
  "template_id": "cf2941d1-b11f-4065-970b-7150a652422b",
  "title": "Or√ßamento Projeto X",
  "items": [
    {
      "category_id": "9358dfd3-592a-430e-a3f4-d9c12315f9f0",
      "field_values": {
        "78edb949-db9d-4d13-8650-98905285afdd": "Material A",
        "1b651f04-d72a-4118-85b7-f9bc646d4399": 100,
        "f4d10a5b-efec-46dc-936a-abdf40e5bc9f": "Observa√ß√£o"
      },
      "order": 0
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "message": "Or√ßamento criado com sucesso",
  "data": {
    "id": "budget-uuid",
    "title": "Or√ßamento Projeto X",
    "status": "draft",
    "total_amount": 118.00,
    "custom_data": {
      "subtotals": {
        "Materiais": 100
      },
      "metadata": {
        "base_total": 100,
        "taxes": 18,
        "strategy_used": "default"
      }
    }
  }
}
```

## üßÆ Sistema de C√°lculos

### Estrat√©gias Dispon√≠veis

#### 1. **Default Strategy**
- C√°lculos b√°sicos para or√ßamentos simples
- Soma valores por categoria
- Aplica taxa de imposto padr√£o (18%)

#### 2. **Industrial Strategy** 
- C√°lculos espec√≠ficos para projetos industriais
- Considera fatores de complexidade
- Margem de lucro diferenciada

#### 3. **Service Strategy**
- Voltado para or√ßamentos de servi√ßos
- C√°lculo baseado em horas/homem
- Custos operacionais inclusos

### Como Adicionar Nova Estrat√©gia

1. **Crie a classe da estrat√©gia:**
```typescript
@Injectable()
export class CustomStrategy implements ICalculationStrategy {
  readonly type = 'custom';

  async validate(template: BudgetTemplate, items: BudgetItemDto[]): Promise<ValidationResult> {
    // Implementar valida√ß√£o
  }

  async calculate(template: BudgetTemplate, items: BudgetItemDto[], context: CalculationContext): Promise<CalculationResult> {
    // Implementar c√°lculo
  }
}
```

2. **Registre no m√≥dulo:**
```typescript
@Module({
  providers: [
    // ... outras estrat√©gias
    CustomStrategy,
  ],
})
export class BudgetsModule {}
```

3. **Registre no engine:**
```typescript
// calculation.engine.ts
private registerStrategies() {
  this.strategies.set('custom', this.customStrategy);
}
```

## üóÑÔ∏è Estrutura do Banco de Dados

```mermaid
erDiagram
    COMPANIES ||--o{ BUDGET_TEMPLATES : has
    COMPANIES ||--o{ BUDGETS : creates
    
    BUDGET_TEMPLATES ||--o{ BUDGET_CATEGORIES : contains
    BUDGET_TEMPLATES ||--o{ BUDGETS : generates
    
    BUDGET_CATEGORIES ||--o{ BUDGET_FIELDS : has
    BUDGET_CATEGORIES ||--o{ BUDGET_ITEMS : categorizes
    
    BUDGETS ||--o{ BUDGET_ITEMS : contains
    
    COMPANIES {
        uuid id PK
        string name
        string email
        string document
        json settings
        timestamp created_at
        timestamp updated_at
    }
    
    BUDGET_TEMPLATES {
        uuid id PK
        string name
        string description
        boolean is_active
        json calculation_rules
        uuid company_id FK
        timestamp created_at
    }
    
    BUDGET_CATEGORIES {
        uuid id PK
        string name
        integer order
        boolean is_repeatable
        json validation_rules
        uuid template_id FK
    }
    
    BUDGET_FIELDS {
        uuid id PK
        string label
        string type
        boolean required
        json options
        json validation
        integer order
        json calculation
        uuid category_id FK
    }
    
    BUDGETS {
        uuid id PK
        string title
        enum status
        json custom_data
        decimal total_amount
        integer version
        uuid company_id FK
        uuid template_id FK
        timestamp created_at
    }
    
    BUDGET_ITEMS {
        uuid id PK
        json field_values
        decimal amount
        integer order
        uuid budget_id FK
        uuid category_id FK
    }
```

## üèóÔ∏è Arquitetura de M√≥dulos

### Estrutura de Pastas
```
src/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Autentica√ß√£o e autoriza√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies/    # JWT, Local strategies
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/        # Auth guards
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/          # Data Transfer Objects
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ companies/         # Gest√£o de empresas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ templates/         # Templates de or√ßamento
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/     # Template, Category, Field
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ budgets/          # Sistema de or√ßamentos
‚îÇ       ‚îú‚îÄ‚îÄ controllers/
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ entities/     # Budget, BudgetItem
‚îÇ       ‚îú‚îÄ‚îÄ dto/
‚îÇ       ‚îî‚îÄ‚îÄ calculation/  # Engine de c√°lculos
‚îÇ           ‚îú‚îÄ‚îÄ strategies/
‚îÇ           ‚îú‚îÄ‚îÄ interfaces/
‚îÇ           ‚îî‚îÄ‚îÄ calculation.engine.ts
‚îÇ
‚îú‚îÄ‚îÄ config/               # Configura√ß√µes
‚îú‚îÄ‚îÄ database/            # Migrations e seeds
‚îú‚îÄ‚îÄ common/              # Utilit√°rios compartilhados
‚îî‚îÄ‚îÄ shared/              # M√≥dulos compartilhados
```

### Princ√≠pios Arquiteturais

- **Modular**: Cada funcionalidade √© um m√≥dulo independente
- **SOLID**: Aplica√ß√£o dos princ√≠pios SOLID
- **DRY**: N√£o repeti√ß√£o de c√≥digo
- **Strategy Pattern**: Para o sistema de c√°lculos
- **Repository Pattern**: Abstra√ß√£o do acesso a dados
- **Dependency Injection**: Invers√£o de depend√™ncias

## üöÄ Deploy

### Docker (Recomendado)

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

RUN npm run build

EXPOSE 3001

CMD ["npm", "run", "start:prod"]
```

### Docker Compose
```yaml
version: '3.8'
services:
  api:
    build: .
    ports:
      - "3001:3001"
    environment:
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres
      - DB_DATABASE=orcapro_db
    depends_on:
      - db
      
  db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=orcapro_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      
volumes:
  postgres_data:
```

## üß™ Testes

```bash
# Testes unit√°rios
npm run test

# Testes e2e
npm run test:e2e

# Coverage
npm run test:cov
```

## üìà Monitoramento

O sistema inclui:
- **Logs estruturados** com Winston
- **Health checks** para database e API
- **M√©tricas** de performance
- **Error tracking** com contexto completo

## ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch (`git checkout -b feature/nova-feature`)
3. Commit suas mudan√ßas (`git commit -am 'Add nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para detalhes.

## üë• Equipe

- **Desenvolvedor Backend**: Bryan
- **Arquitetura**: Sistema modular com NestJS
- **Database**: PostgreSQL com TypeORM

---

üîó **Links Relacionados:**
- [Frontend Repository](https://github.com/Bryannps/2FrontOrcaPro)
- [Documenta√ß√£o da API](http://localhost:3001/api/docs)
- [Postman Collection](./docs/postman-collection.json)